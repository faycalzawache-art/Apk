name: Ultimate Android APK Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  FLUTTER_VERSION: '3.22.0'  # Ù†Ø³Ø®Ø© Flutter Ù…Ø³ØªÙ‚Ø±Ø©
  ORG_NAME: "com.example.app"
  PROJECT_NAME: "flet_pro_app"
  BUILD_TYPE: "release"  # Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Ù…Ù‡Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø·ÙˆÙŠÙ„

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet[all]  # ØªØ«Ø¨ÙŠØª Flet Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
          
          # Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯
          if [ -f requirements.txt ]; then
            # ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© ÙÙŠ ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
            sed -i 's/lask/flask/g; s/Flask/flask/g; s/requirments/requirements/g' requirements.txt
            # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø©
            pip install -r requirements.txt || echo "Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù‚Ø¯ ÙØ´Ù„ ØªØ«Ø¨ÙŠØªÙ‡Ø§ØŒ Ù„ÙƒÙ†Ù†Ø§ Ù†ÙˆØ§ØµÙ„..."
          fi

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libegl1-mesa \
            libgles2-mesa \
            xvfb \
            unzip \
            wget \
            curl
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ©"

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: Verify Flutter Installation
        run: |
          flutter --version
          flutter doctor
          flutter config --no-analytics

      - name: Install Android SDK (Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
        run: |
          sdkmanager --list || echo "Android SDK Manager ØºÙŠØ± Ù…ØªÙˆÙØ±"
          # ØªØ«Ø¨ÙŠØª Ø­Ø²Ù… Android SDK Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
          yes | sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"

      - name: Build APK with Flet
        run: |
          # ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
          export FLET_BUILD_VERBOSE=1
          export FLET_BUILD_NO_CACHE=false
          
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ APK..."
          
          # Ø¨Ù†Ø§Ø¡ APK Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø­Ø³Ù†Ø©
          flet build apk \
            --verbose \
            --yes \
            --org "${{ env.ORG_NAME }}" \
            --project "${{ env.PROJECT_NAME }}" \
            --build-number "${{ github.run_number }}" \
            --build-version "1.0.${{ github.run_number }}" \
            --no-pub  # Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø­Ø²Ù… Dart Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡
          
          echo "âœ… Ø§ÙƒØªÙ…Ù„ Ø¨Ù†Ø§Ø¡ APK"

      - name: List Generated APK Files
        run: |
          echo "ğŸ“ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡:"
          find build/apk -type f -name "*.apk" 2>/dev/null || echo "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª APK"
          ls -la build/apk/*.apk 2>/dev/null || true

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: App-APK-v${{ github.run_number }}
          path: |
            build/apk/*.apk
            build/apk/output.json
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Build Logs (Ù„Ù„ØªØµØ­ÙŠØ­)
        if: always()  # Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs-v${{ github.run_number }}
          path: |
            ~/.flet/build.log
            /tmp/flet-build-*.log
          retention-days: 7
